#!/bin/bash

GAMEUSER="gameuser"

function create_game_user {
    if ! getent passwd "$GAMEUSER" > /dev/null 2>&1; then
        useradd -m -s /bin/bash "$GAMEUSER"
        # Generate random password
        PASS="$GAMEUSER"
        echo "$GAMEUSER:$PASS" | chpasswd
    fi
}

function clone_or_update_gameservers {
    if [ -d "/root/gameservers" ]; then
        cd "/root/gameservers"
        git pull
    else
        git clone "https://github.com/jesinmat/linux-gameservers.git" /root/gameservers
    fi
}

create_game_user

if [ ! -d "/etc/gameserver" ] || [ ! -f "/etc/gameserver/gameserver" ]; then
    mkdir -p "/etc/gameserver"
    clone_or_update_gameservers
    python3 "/usr/local/bin/gameserver-menu.py" "/root/gameservers/"
    echo 'Game:      $ipaddr' >> /etc/confconsole/services.txt
fi

if [ ! -f "/etc/gameserver/installation.done" ]; then
    . /etc/gameserver/gameserver

    cd "/root/gameservers"
    chmod +x "auto_install.sh"
    bash "./auto_install.sh" -g "$GAME" -u "$GAMEUSER" -p "/home/$GAMEUSER/gameserver"
    
    touch "/etc/gameserver/installation.done"
fi

/usr/local/bin/gameserver-start
