#!/bin/bash -e

GAMEUSER="gameuser"
LOGFILE="/var/log/gameserver/install.log"
GAME_REPO_DIR="/root/gameservers"

fatal() { echo "FATAL: $@"; exit 1; }

select_game_interactive() {
    python3 "/usr/local/bin/gameserver-menu.py" "$GAME_REPO_DIR"
}

select_game_auto() {
    cp "$GAME_REPO_DIR/games/$GAME/game_properties.sh" "/etc/gameserver/gameserver"
}

select_game() {
    if [ ! -d "/etc/gameserver" ] || [ ! -f "/etc/gameserver/gameserver" ]; then
        mkdir -p "/etc/gameserver"

        if [ -n "$GAME" ]; then
            select_game_auto
        else
            # Exit if not running interactively, game will be selected on first login
            echo $(stty size) >> /root/tty.size
            [[ -n $(stty size) ]] || exit 0
            select_game_interactive
        fi
        
        echo 'GameServer: $ipaddr' | cat - /etc/confconsole/services.txt > temp_confconsole
        mv temp_confconsole /etc/confconsole/services.txt
    fi
}

install_game() {
    if [ ! -f "/etc/gameserver/installation.done" ]; then
        conf=/etc/gameserver/gameserver
        [[ -f "$conf" ]] || fatal "Conf file ($conf) not found."
        . $conf

        cd "$GAME_REPO_DIR"
        chmod +x "auto_install.sh"
        bash "./auto_install.sh" -g "$GAME" -u "$GAMEUSER" -p "/home/$GAMEUSER/gameserver"
        
        touch "/etc/gameserver/installation.done"

        # Enable server start on boot
        systemctl enable gameserver
    fi
    systemctl start gameserver
}

select_game
install_game 2>&1 | tee -a "$LOGFILE"
